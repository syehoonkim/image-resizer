<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Batch Image Resizer (Client Only)</title>

    <style>
      body {
        margin: 0;
        font-family:
          system-ui,
          -apple-system,
          "Segoe UI",
          Roboto,
          "Noto Sans KR",
          Arial,
          sans-serif;
        background: #0b0f1a;
        color: #e8eefc;
      }
      .wrap {
        max-width: 1200px;
        margin: 30px auto;
        padding: 0 16px 50px;
      }
      h1 {
        font-size: 22px;
        margin: 0 0 6px;
      }
      .sub {
        color: #a8b3d6;
        font-size: 13px;
        margin-bottom: 18px;
      }

      .grid {
        display: grid;
        grid-template-columns: 460px 1fr;
        gap: 16px;
      }
      @media (max-width: 1024px) {
        .grid {
          grid-template-columns: 1fr;
        }
      }

      .card {
        background: #121a2b;
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 16px;
        overflow: hidden;
      }
      .card h2 {
        margin: 0;
        padding: 14px 16px;
        font-size: 15px;
        background: #0f1626;
        border-bottom: 1px solid rgba(255, 255, 255, 0.12);
      }
      .content {
        padding: 14px 16px 16px;
      }

      .drop {
        border: 1px dashed rgba(255, 255, 255, 0.3);
        border-radius: 14px;
        padding: 16px;
        background: #0f1626;
        text-align: center;
        transition: 0.12s ease;
      }
      .drop.dragover {
        background: #1a2440;
        border-color: #6aa6ff;
      }

      .btn {
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: #1a2440;
        color: #e8eefc;
        padding: 10px 14px;
        border-radius: 12px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 600;
      }
      .btn.secondary {
        background: #0f1626;
      }
      .btn.danger {
        background: #402020;
        border-color: #ff6a6a;
      }
      .btn:disabled {
        opacity: 0.55;
        cursor: not-allowed;
      }

      input[type="file"] {
        display: none;
      }

      label {
        font-size: 12px;
        color: #a8b3d6;
        display: block;
        margin-bottom: 6px;
      }
      .field {
        background: #0f1626;
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 12px;
        padding: 10px;
      }
      input[type="text"],
      select {
        width: 100%;
        border: 0;
        outline: none;
        background: transparent;
        color: #e8eefc;
        font-size: 14px;
      }

      .range {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      input[type="range"] {
        width: 100%;
      }

      .pill {
        background: #0f1626;
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 999px;
        padding: 8px 10px;
        font-size: 12px;
        color: #a8b3d6;
        white-space: nowrap;
      }
      .pill b {
        color: #e8eefc;
      }

      .help {
        color: #a8b3d6;
        font-size: 12px;
        margin-top: 6px;
      }

      .list {
        margin-top: 12px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 14px;
        overflow: hidden;
      }
      .listHead {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 12px;
        background: #0f1626;
        border-bottom: 1px solid rgba(255, 255, 255, 0.12);
      }
      .listBody {
        max-height: 340px;
        overflow: auto;
      }
      .item {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 10px;
        padding: 10px 12px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      }
      .item:last-child {
        border-bottom: 0;
      }
      .name {
        font-size: 13px;
        font-weight: 650;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .meta {
        font-size: 12px;
        color: #a8b3d6;
        margin-top: 3px;
      }
      .xbtn {
        border: 1px solid rgba(255, 255, 255, 0.16);
        background: transparent;
        color: #e8eefc;
        border-radius: 10px;
        padding: 6px 10px;
        cursor: pointer;
      }
      .xbtn:hover {
        border-color: rgba(255, 255, 255, 0.3);
      }

      .preview {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }
      @media (max-width: 1024px) {
        .preview {
          grid-template-columns: 1fr;
        }
      }

      .imgframe {
        background: #0f1626;
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 14px;
        min-height: 260px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
      }
      .imgframe img {
        max-width: 100%;
        max-height: 520px;
        object-fit: contain;
        display: none;
      }
      .empty {
        color: #a8b3d6;
        font-size: 13px;
        text-align: center;
        padding: 20px;
      }
      .badge {
        position: absolute;
        left: 10px;
        top: 10px;
        background: rgba(0, 0, 0, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 999px;
        padding: 6px 10px;
        font-size: 12px;
        z-index: 2;
      }

      .row {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }
      .mono {
        font-family:
          ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", monospace;
      }
      .toast {
        margin-top: 12px;
        padding: 10px 12px;
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(0, 0, 0, 0.12);
        color: #a8b3d6;
        font-size: 12px;
        display: none;
      }
      .toast.show {
        display: block;
      }

      option {
        background: #121a2b;
        color: #e8eefc;
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <h1>Batch Image Resizer</h1>
      <div class="sub">
        여러 이미지를 동시에 업로드 → 동일한 %로 일괄 리사이즈 → 순차 다운로드
        (서버 없음)
      </div>

      <div class="grid">
        <!-- LEFT: 업로드 + 리스트 -->
        <section class="card">
          <h2>1) 이미지 업로드</h2>
          <div class="content">
            <div id="drop" class="drop">
              <div style="font-weight: 700; margin-bottom: 8px">
                이미지를 여러 개 드래그&드롭
              </div>
              <label
                class="btn secondary"
                for="file"
                style="display: inline-block"
                >파일 선택 (multiple)</label
              >
              <div class="help">지원: JPG/PNG/WebP 등 · 여러 개 선택 가능</div>
            </div>

            <input id="file" type="file" accept="image/*" multiple />

            <div class="list">
              <div class="listHead">
                <div class="row">
                  <span class="pill"><b id="count">0</b> files</span>
                  <span class="pill">선택된 파일을 클릭하면 미리보기 표시</span>
                </div>
                <div class="row">
                  <button id="clear" class="btn danger" type="button">
                    전체 삭제
                  </button>
                </div>
              </div>
              <div id="listBody" class="listBody">
                <div
                  style="padding: 14px 12px; color: #a8b3d6; font-size: 13px"
                >
                  아직 업로드된 파일이 없습니다.
                </div>
              </div>
            </div>

            <div id="toast" class="toast"></div>
          </div>
        </section>

        <!-- RIGHT: 설정 -->
        <section class="card">
          <h2>2) 일괄 리사이징 설정</h2>
          <div class="content">
            <label>크기 조절 (%) — 모든 이미지에 동일 적용</label>
            <div class="field">
              <div class="range">
                <input id="scale" type="range" min="10" max="200" value="50" />
                <div class="pill"><b id="scaleVal" class="mono">50%</b></div>
              </div>
              <div class="help">
                예) 50%를 선택하면, 각 이미지의 (원본W×0.5, 원본H×0.5)로
                변환됩니다. 원본 크기가 모두 달라도 문제 없습니다.
              </div>
            </div>

            <div style="margin-top: 12px" class="row">
              <span class="pill">출력 크기 예시:</span>
              <span class="pill mono" id="example">-</span>
            </div>

            <div style="margin-top: 12px">
              <label>출력 포맷</label>
              <div class="field">
                <select id="fmt">
                  <option value="image/jpeg">JPEG</option>
                  <option value="image/png">PNG</option>
                  <option value="image/webp">WebP</option>
                </select>
              </div>
            </div>

            <div style="margin-top: 12px">
              <label>출력 파일명 규칙</label>
              <div class="field">
                <input id="pattern" type="text" value="{name}_{scale}pct" />
              </div>
              <div class="help">
                사용 가능 변수: <span class="mono">{name}</span> (원본 파일명),
                <span class="mono">{scale}</span> (퍼센트) <br />예:
                {name}_{scale}pct → IMG_0001_50pct.jpg
              </div>
            </div>

            <div style="margin-top: 12px">
              <label>품질 (JPEG/WebP)</label>
              <div class="field">
                <div class="range">
                  <input
                    id="quality"
                    type="range"
                    min="0"
                    max="1"
                    step="0.01"
                    value="0.9"
                  />
                  <div class="pill"><b id="qVal" class="mono">0.90</b></div>
                </div>
                <div class="help">PNG는 품질 설정이 적용되지 않습니다.</div>
              </div>
            </div>

            <div
              style="
                margin-top: 14px;
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
              "
            >
              <button id="applyOne" class="btn secondary" type="button">
                선택 파일 변환 미리보기
              </button>
              <button id="downloadAll" class="btn" type="button">
                전체 파일 변환 & 다운로드
              </button>
            </div>

            <div class="help" style="margin-top: 10px">
              브라우저 정책상 파일이 많으면 다운로드가 여러 번 뜰 수 있습니다.
              (ZIP 없음)
            </div>
          </div>
        </section>
      </div>

      <!-- PREVIEW -->
      <section class="card" style="margin-top: 16px">
        <h2>3) 미리보기 (선택된 파일)</h2>
        <div class="content">
          <div class="preview">
            <div class="imgframe">
              <div class="badge">원본</div>
              <img id="imgIn" />
              <div id="emptyIn" class="empty">
                왼쪽 목록에서 파일을 선택하세요
              </div>
            </div>
            <div class="imgframe">
              <div class="badge">출력</div>
              <img id="imgOut" />
              <div id="emptyOut" class="empty">
                “선택 파일 변환 미리보기”를 누르세요
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);

      let files = []; // { id, file, nameNoExt, bitmap, w, h, url }
      let selectedId = null;
      let outUrl = null;

      function showToast(msg, isError = false) {
        const t = $("toast");
        t.textContent = msg;
        t.style.borderColor = isError
          ? "rgba(255,106,106,.35)"
          : "rgba(255,255,255,.12)";
        t.style.color = isError ? "#ffd2d2" : "#a8b3d6";
        t.classList.add("show");
        clearTimeout(showToast._t);
        showToast._t = setTimeout(() => t.classList.remove("show"), 2600);
      }

      function baseName(name) {
        return (name || "image").replace(/\.[^.]+$/, "");
      }
      function extFromMime(mime) {
        if (mime === "image/png") return "png";
        if (mime === "image/jpeg") return "jpg";
        if (mime === "image/webp") return "webp";
        return "img";
      }

      function fmtBytes(bytes) {
        const units = ["B", "KB", "MB", "GB"];
        let n = bytes,
          i = 0;
        while (n >= 1024 && i < units.length - 1) {
          n /= 1024;
          i++;
        }
        return `${n.toFixed(i === 0 ? 0 : 2)} ${units[i]}`;
      }

      function updateCount() {
        $("count").textContent = String(files.length);
        $("downloadAll").disabled = files.length === 0;
        $("applyOne").disabled = files.length === 0 || !selectedId;
        $("clear").disabled = files.length === 0;
      }

      function renderList() {
        const body = $("listBody");
        body.innerHTML = "";

        if (files.length === 0) {
          body.innerHTML = `<div style="padding:14px 12px; color:#a8b3d6; font-size:13px;">
      아직 업로드된 파일이 없습니다.
    </div>`;
          updateCount();
          return;
        }

        for (const it of files) {
          const div = document.createElement("div");
          div.className = "item";
          div.style.cursor = "pointer";
          div.style.background =
            it.id === selectedId ? "rgba(106,166,255,.14)" : "transparent";

          const left = document.createElement("div");
          left.innerHTML = `
      <div class="name">${it.file.name}</div>
      <div class="meta mono">${it.w}x${it.h} · ${fmtBytes(it.file.size)} · ${it.file.type}</div>
    `;

          const right = document.createElement("div");
          const btn = document.createElement("button");
          btn.className = "xbtn";
          btn.type = "button";
          btn.textContent = "삭제";
          btn.addEventListener("click", (e) => {
            e.stopPropagation();
            removeFile(it.id);
          });
          right.appendChild(btn);

          div.appendChild(left);
          div.appendChild(right);

          div.addEventListener("click", () => selectFile(it.id));
          body.appendChild(div);
        }

        updateCount();
      }

      function updateExample() {
        const scale = parseInt($("scale").value, 10);
        $("scaleVal").textContent = `${scale}%`;

        if (!selectedId) {
          $("example").textContent = "-";
          return;
        }
        const it = files.find((x) => x.id === selectedId);
        if (!it) {
          $("example").textContent = "-";
          return;
        }
        const nw = Math.max(1, Math.round((it.w * scale) / 100));
        const nh = Math.max(1, Math.round((it.h * scale) / 100));
        $("example").textContent = `${it.w}x${it.h} → ${nw}x${nh}`;
      }

      function resetOutPreview() {
        if (outUrl) URL.revokeObjectURL(outUrl);
        outUrl = null;
        $("imgOut").style.display = "none";
        $("emptyOut").style.display = "block";
        $("imgOut").src = "";
      }

      function setInPreview(it) {
        $("imgIn").src = it.url;
        $("imgIn").style.display = "block";
        $("emptyIn").style.display = "none";
      }

      function clearInPreview() {
        $("imgIn").src = "";
        $("imgIn").style.display = "none";
        $("emptyIn").style.display = "block";
      }

      function selectFile(id) {
        selectedId = id;
        renderList();
        resetOutPreview();

        const it = files.find((x) => x.id === id);
        if (!it) {
          clearInPreview();
          updateExample();
          updateCount();
          return;
        }

        setInPreview(it);
        $("applyOne").disabled = false;
        updateExample();
      }

      function removeFile(id) {
        const idx = files.findIndex((x) => x.id === id);
        if (idx < 0) return;

        const it = files[idx];
        if (it.url) URL.revokeObjectURL(it.url);
        files.splice(idx, 1);

        if (selectedId === id) {
          selectedId = files.length ? files[0].id : null;
          resetOutPreview();
          if (selectedId) {
            const next = files.find((x) => x.id === selectedId);
            setInPreview(next);
          } else {
            clearInPreview();
          }
        }

        renderList();
        updateExample();
        showToast("파일이 삭제되었습니다.");
      }

      async function addFiles(fileList) {
        const add = Array.from(fileList || []).filter(
          (f) => f && f.type && f.type.startsWith("image/"),
        );
        if (add.length === 0) {
          showToast("이미지 파일을 업로드하세요.", true);
          return;
        }

        // 순차 처리 (메모리/CPU 급격 상승 방지)
        for (const file of add) {
          try {
            const bitmap = await createImageBitmap(file);
            const id = crypto.randomUUID();
            const url = URL.createObjectURL(file);

            files.push({
              id,
              file,
              nameNoExt: baseName(file.name),
              bitmap,
              w: bitmap.width,
              h: bitmap.height,
              url,
            });
          } catch (e) {
            console.error(e);
            showToast(`디코딩 실패: ${file.name}`, true);
          }
        }

        // 선택 파일 없으면 첫 파일 자동 선택
        if (!selectedId && files.length > 0) {
          selectedId = files[0].id;
          setInPreview(files[0]);
        }

        renderList();
        updateExample();
        showToast(`${add.length}개 파일 추가 완료`);
      }

      function makeOutName(nameNoExt, scale) {
        const pattern = ($("pattern").value || "{name}_{scale}pct").trim();
        return pattern
          .replaceAll("{name}", nameNoExt)
          .replaceAll("{scale}", String(scale));
      }

      async function convertOne(it) {
        const scale = parseInt($("scale").value, 10);
        const fmt = $("fmt").value;
        const q = parseFloat($("quality").value);

        const w = Math.max(1, Math.round((it.w * scale) / 100));
        const h = Math.max(1, Math.round((it.h * scale) / 100));

        const canvas = document.createElement("canvas");
        canvas.width = w;
        canvas.height = h;

        const ctx = canvas.getContext("2d");
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = "high";
        ctx.drawImage(it.bitmap, 0, 0, w, h);

        const blob = await new Promise((resolve) => {
          if (fmt === "image/png") canvas.toBlob(resolve, fmt);
          else canvas.toBlob(resolve, fmt, q);
        });

        return { blob, w, h, fmt, scale };
      }

      async function previewSelected() {
        if (!selectedId) {
          showToast("미리보기할 파일을 선택하세요.", true);
          return;
        }
        const it = files.find((x) => x.id === selectedId);
        if (!it) return;

        try {
          resetOutPreview();
          const { blob } = await convertOne(it);

          outUrl = URL.createObjectURL(blob);
          $("imgOut").src = outUrl;
          $("imgOut").style.display = "block";
          $("emptyOut").style.display = "none";
          showToast("미리보기 변환 완료");
        } catch (e) {
          console.error(e);
          showToast("변환 실패", true);
        }
      }

      function downloadBlob(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(url), 1500);
      }

      // 전체 다운로드: 순차 변환+다운로드
      async function downloadAll() {
        if (files.length === 0) {
          showToast("다운로드할 파일이 없습니다.", true);
          return;
        }

        $("downloadAll").disabled = true;
        $("applyOne").disabled = true;

        const scale = parseInt($("scale").value, 10);
        const fmt = $("fmt").value;
        const ext = extFromMime(fmt);

        try {
          showToast("전체 변환 시작…");

          for (let i = 0; i < files.length; i++) {
            const it = files[i];
            const { blob } = await convertOne(it);

            const outBase =
              makeOutName(it.nameNoExt, scale)
                .replace(/[\\/:*?"<>|]+/g, "_")
                .trim() || it.nameNoExt;
            const filename = `${outBase}.${ext}`;
            downloadBlob(blob, filename);

            // 브라우저 다운로드 이벤트가 연속으로 너무 빨리 발생하면 차단될 수 있어 약간 텀
            await new Promise((r) => setTimeout(r, 220));
          }

          showToast("전체 다운로드 요청 완료");
        } catch (e) {
          console.error(e);
          showToast("전체 변환 중 오류 발생", true);
        } finally {
          $("downloadAll").disabled = false;
          $("applyOne").disabled = files.length === 0 || !selectedId;
        }
      }

      function clearAll() {
        for (const it of files) {
          if (it.url) URL.revokeObjectURL(it.url);
        }
        files = [];
        selectedId = null;
        resetOutPreview();
        clearInPreview();
        renderList();
        updateExample();
        showToast("전체 삭제되었습니다.");
      }

      // events
      $("file").addEventListener("change", (e) => addFiles(e.target.files));
      $("drop").addEventListener("dragover", (e) => {
        e.preventDefault();
        $("drop").classList.add("dragover");
      });
      $("drop").addEventListener("dragleave", () =>
        $("drop").classList.remove("dragover"),
      );
      $("drop").addEventListener("drop", (e) => {
        e.preventDefault();
        $("drop").classList.remove("dragover");
        addFiles(e.dataTransfer.files);
      });

      $("clear").addEventListener("click", clearAll);

      $("scale").addEventListener("input", () => {
        updateExample();
        resetOutPreview();
      });

      $("fmt").addEventListener("change", () => {
        resetOutPreview();
      });

      $("quality").addEventListener("input", () => {
        $("qVal").textContent = Number($("quality").value).toFixed(2);
        resetOutPreview();
      });

      $("applyOne").addEventListener("click", previewSelected);
      $("downloadAll").addEventListener("click", downloadAll);

      // init
      $("scaleVal").textContent = $("scale").value + "%";
      $("qVal").textContent = Number($("quality").value).toFixed(2);
      renderList();
      updateCount();
      updateExample();
      $("downloadAll").disabled = true;
      $("applyOne").disabled = true;
      $("clear").disabled = true;
    </script>
  </body>
</html>
